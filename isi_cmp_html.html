<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ISI Student Competition</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css"/>
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        #queryWidget{
            position: absolute;
            bottom: 30px;
            right: 20px;
            background-color: aliceblue;
            outline: 4px solid black;
            border-radius: 5px;
        }

    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>
    <script src="https://js.arcgis.com/4.24/"></script>
    <script>
        require(["esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/widgets/Legend", "esri/widgets/Search", "esri/widgets/Home", "esri/smartMapping/statistics/uniqueValues"],
            (Map, MapView, FeatureLayer, Legend, Search, Home, uniqueValues) =>{
            $(function(){
                // load in data
                const map = new Map({
                    basemap: 'gray-vector'
                });
                const view = new MapView({
                    map: map,
                    container: 'viewDiv',
                    center: [-96.547302, 51.648414],
                    zoom: 4
                });

                const forestFireLayer = new FeatureLayer({
                    url: 'https://services1.arcgis.com/0MSEUqKaxRlEPj5g/arcgis/rest/services/Forest_Fire_Prediction_in_Canada_8_Years/FeatureServer/0'
                });
                map.add(forestFireLayer);

                let legend = new Legend({view: view});
                view.ui.add(legend, 'bottom-left');

                const search = new Search({view: view});
                view.ui.add(search, {position: 'top-left', index: 0});

                const homeButton = new Home({view: view});
                view.ui.add(homeButton, 'top-left');

                // set up query widget
                uniqueValues({
                    layer: forestFireLayer,
                    field: 'fire_cause_text'
                }).then(function (values){
                    console.log(values);
                    const queryWidget = $('<div id="queryWidget"><div>Query by Cause of Fire</div></div>');
                    values.uniqueValueInfos.reverse().forEach((val) => {
                        console.log(val.value);
                        let option = $(`<div><span><input id="${val.value}" type="checkbox">${val.value}</span></div>`);
                        $(queryWidget).append(option);
                    });
                    queryWidget.appendTo($('body'));

                    $('input:checkbox').click(() =>{
                        let checkedOptions = $('input:checkbox:checked');
                        console.log(checkedOptions);
                        if (checkedOptions.length === 0){
                            forestFireLayer.definitionExpression = '';
                        } else {
                            let expression = '';
                            checkedOptions.each((idx, obj) =>{
                                console.log(obj);
                                expression = expression + `fire_cause_text = '${obj.id}' OR `
                            });
                            console.log(expression.slice(0, -4));
                            forestFireLayer.definitionExpression = expression.slice(0, -4);
                        }
                    });
                });

            }); // end of jquery
        }); // end of arcgis js sdk
    </script>
</head>
<body>
    <div id="viewDiv"></div>
</body>
</html>
